<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Security Event Ledger</title>
    <style>
      :root { box-sizing: border-box; }
      *, *::before, *::after { box-sizing: inherit; }
      html, body { height: 100%; }
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        background: #050712;
        color: #e5e7eb;
        overflow: hidden;
      }
      h1, h2 { color: #f9e076; }
      h1 { font-size: 1.8rem; margin: 0; font-weight: 600; }
      h2 { font-size: 1.1rem; margin: 0 0 0.25rem 0; font-weight: 500; }
      label { display: block; margin-top: 0.5rem; }
      input, textarea, select { width: 100%; padding: 0.4rem; margin-top: 0.25rem; border-radius: 4px; border: 1px solid #4b5563; background: #020617; color: #e5e7eb; }
      button {
        margin-top: 0.5rem;
        padding: 0.45rem 0.9rem;
        border-radius: 4px;
        border: 1px solid #334155;
        background: #0f172a;
        color: #e5e7eb;
        font-weight: 500;
        cursor: pointer;
        font-size: 0.85rem;
      }
      button.secondary { background: #1d4ed8; border-color: #2563eb; color: #e5e7eb; }
      button:disabled { opacity: 0.6; cursor: default; }
      button:hover:not(:disabled) { background: #111827; }
      .app-shell {
        height: 100vh;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .app-header {
        width: 100%;
        max-width: 1200px;
        margin-bottom: 0.5rem;
      }

      .row {
        display: grid;
        grid-template-columns: 320px minmax(0, 1fr);
        gap: 1.5rem;
        width: 100%;
        max-width: 1200px;
        flex: 1;
        min-height: 0;
      }

      .col-left {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        min-height: 0;
        overflow: hidden;
      }

      .col-right {
        display: flex;
        flex-direction: column;
        min-height: 0;
        overflow: hidden;
      }
      .card { background: #020617; border-radius: 10px; padding: 1rem; border: 1px solid #111827; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.45); }
      .card-scroll { flex: 1; min-height: 0; display: flex; flex-direction: column; overflow: hidden; }
      pre { background: #020617; padding: 0.75rem; border-radius: 6px; overflow: auto; border: 1px solid #111827; font-size: 0.85rem; }
      .status-ok { color: #4ade80; }
      .status-bad { color: #fca5a5; }
      small { color: #9ca3af; }
      .app-subtitle { margin: 0.15rem 0 0; font-size: 0.85rem; }
      .chain-tree { flex: 1; min-height: 0; overflow: auto; border-radius: 8px; border: 1px solid #111827; padding: 0.5rem 0.75rem; background: #020617; }
      .block-node { border-left: 2px solid #1f2937; margin-left: 0.5rem; padding-left: 0.75rem; margin-bottom: 0.75rem; }
      .block-header { display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; }
      .block-index { font-weight: 600; color: #fbbf24; }
      .block-hash { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 0.7rem; color: #9ca3af; }
      .event-list { margin-top: 0.5rem; margin-left: 0.25rem; border-left: 1px dashed #374151; padding-left: 0.5rem; }
      .event-item { margin-bottom: 0.35rem; font-size: 0.8rem; }
      .event-type { display: inline-block; padding: 0.05rem 0.4rem; border-radius: 999px; font-weight: 600; margin-right: 0.35rem; }
      .event-type.info { background: #1d4ed8; color: #dbeafe; }
      .event-type.high { background: #b91c1c; color: #fee2e2; }
      .event-type.medium { background: #c05621; color: #ffedd5; }
      .event-source { color: #a5b4fc; }
      .event-timestamp { color: #6b7280; margin-left: 0.35rem; }
      .alerts-list { max-height: 220px; overflow-y: auto; margin-top: 0.5rem; border-radius: 6px; border: 1px solid #111827; padding: 0.4rem 0.6rem; background: #020617; }
      .alert-item { font-size: 0.8rem; margin-bottom: 0.35rem; }
      .muted { color: #9ca3af; font-size: 0.75rem; }
      .stats { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 0.25rem 0.75rem; font-size: 0.8rem; }
      .stats-label { color: #9ca3af; }
      .stats-value { font-weight: 600; }
      .config-card {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        min-height: 0;
      }

      .config-layout {
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 0.5rem 1rem;
        font-size: 0.8rem;
      }

      .config-meta {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      .config-pill {
        padding: 0.15rem 0.4rem;
        border-radius: 999px;
        background: #020617;
        border: 1px solid #1f2937;
        font-size: 0.75rem;
        color: #9ca3af;
      }

      .config-scroller {
        max-height: 140px;
        overflow-y: auto;
        border-radius: 8px;
        border: 1px solid #111827;
        padding: 0.4rem 0.6rem;
        background: #020617;
      }

      .config-list { font-size: 0.8rem; list-style: none; padding-left: 0; margin: 0; }
      .config-list li { margin-bottom: 0.15rem; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
      .config-list code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 0.75rem; }

      .config-editor-label { font-size: 0.8rem; margin-top: 0.25rem; display: block; }
      .config-textarea { width: 100%; resize: vertical; min-height: 60px; max-height: 120px; font-size: 0.8rem; }
      .config-footer { font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem; }
      .hidden { display: none !important; }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header class="app-header">
        <h1>Security Event Ledger</h1>
        <p class="app-subtitle"><small>Blockchain-based, tamper-evident log of security and integrity events.</small></p>
      </header>

      <div class="row">
      <div class="col-left">
        <div class="card">
          <h2>Security overview</h2>
          <div class="stats">
            <div><span class="stats-label">Blocks:</span> <span id="stat-blocks" class="stats-value">-</span></div>
            <div><span class="stats-label">File changes:</span> <span id="stat-file-changes" class="stats-value">-</span></div>
            <div><span class="stats-label">Network changes:</span> <span id="stat-net-changes" class="stats-value">-</span></div>
            <div><span class="stats-label">Account changes:</span> <span id="stat-account-changes" class="stats-value">-</span></div>
            <div><span class="stats-label">Errors:</span> <span id="stat-errors" class="stats-value">-</span></div>
          </div>
          <p class="muted" style="margin-top: 0.5rem;">Recent alerts:</p>
          <div id="alerts-list" class="alerts-list">No alerts yet.</div>
        </div>

        <div class="card config-card">
          <div>
            <h2>Current configuration</h2>
            <p class="muted">Runtime settings for integrity checks.</p>
          </div>

          <div class="config-layout">
            <div class="config-meta">
              <span class="config-pill">Interval <span id="cfg-interval">-</span> ms</span>
              <span class="config-pill"><strong id="cfg-roots-count">0</strong> roots</span>
              <span class="config-pill"><strong id="cfg-excludes-count">0</strong> excluded dirs</span>
              <button type="button" id="btn-toggle-excludes" class="secondary" style="margin-left:auto; margin-top:0; padding-inline:0.6rem; font-size:0.78rem;">Manage excluded dirs</button>
            </div>

            <div>
              <span class="muted" style="font-size: 0.8rem;">Roots</span>
              <div class="config-scroller">
                <ul id="cfg-roots" class="config-list"></ul>
              </div>
            </div>
          </div>

          <div>
            <label class="config-editor-la          <div>
            <label class="config-editor-label">
              Edit roots (one per line)
              <textarea id="cfg-roots-input" class="config-textarea" placeholder="C:\\path\\to\\folder"></textarea>
            </label>
            <button type="button" id="btn-save-roots">Save roots</button>
            <p id="cfg-status" class="config-footer"></p>
          </div>

          <div id="cfg-excludes-editor" class="hidden">
            <label class="config-editor-label">
              Edit excluded directories (one per line)
              <textarea id="cfg-excludes-input" class="config-textarea" placeholder="node_modules"></textarea>
            </label>
            <button type="button" id="btn-save-excludes">Save excluded dirs</button>
            <p id="cfg-excludes-status" class="config-footer"></p>
          </div>
        </div>
      </div>

      <div class="col-right">
        <div class="card card-scroll">
          <h2>Ledger status</h2>
          <p>Health: <span id="health-text">loading...</span></p>
          <p>Pending events: <span id="pending-count">0</span></p>
          <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.25rem;">
            <button type="button" id="refresh-btn" class="secondary">Refresh</button>
            <button type="button" id="btn-verify" class="secondary">Validate chain</button>
            <button type="button" id="btn-mine" class="secondary">Mine pending events</button>
          </div>
          <h2 style="margin-top: 1.0rem;">Chain</h2>
        <div id="chain-tree" class="chain-tree">Loading...</div>
        </div>
      </div>
    </div>

    <script>
      async function fetchJSON(url, options) {
        const res = await fetch(url, options);
        const text = await res.text();
        try {
          const data = text ? JSON.parse(text) : null;
          if (!res.ok) {
            const err = new Error(data && data.error ? data.error : res.statusText);
            err.status = res.status;
            throw err;
          }
          return data;
        } catch (e) {
          if (!res.ok) throw e;
          return null;
        }
      }

      function renderConfig(config) {
        const intervalEl = document.getElementById("cfg-interval");
        const rootsEl = document.getElementById("cfg-roots");
        const rootsInput = document.getElementById("cfg-roots-input");
        const excludesInput = document.getElementById("cfg-excludes-input");
        const rootsCountEl = document.getElementById("cfg-roots-count");
        const excludesCountEl = document.getElementById("cfg-excludes-count");

        rootsEl.innerHTML = "";

        if (!config) {
          intervalEl.textContent = "-";
          if (rootsInput) rootsInput.value = "";
          if (excludesInput) excludesInput.value = "";
          if (rootsCountEl) rootsCountEl.textContent = "0";
          if (excludesCountEl) excludesCountEl.textContent = "0";
          return;
        }

        intervalEl.textContent = config.intervalMs ?? "-";

        const roots = config.roots || [];
        const excludes = config.excludeDirs || [];

        if (rootsInput) {
          rootsInput.value = roots.join("\n");
        }
        if (excludesInput) {
          excludesInput.value = excludes.join("\n");
        }
        if (rootsCountEl) rootsCountEl.textContent = String(roots.length);
        if (excludesCountEl) excludesCountEl.textContent = String(excludes.length);

        roots.forEach((r) => {
          const li = document.createElement("li");
          const code = document.createElement("code");
          code.textContent = r;
          li.appendChild(code);
          rootsEl.appendChild(li);
        });
      }

      function renderChainTree(chainPayload) {
        const container = document.getElementById("chain-tree");
        if (!container) return;
        container.innerHTML = "";

        if (!chainPayload || !Array.isArray(chainPayload.chain)) {
          container.textContent = "No chain data";
          return;
        }

        for (const block of chainPayload.chain) {
          const blockNode = document.createElement("div");
          blockNode.className = "block-node";

          const header = document.createElement("div");
          header.className = "block-header";

          const left = document.createElement("div");
          const indexSpan = document.createElement("span");
          indexSpan.className = "block-index";
          indexSpan.textContent = "Block #" + block.index;
          left.appendChild(indexSpan);

          const tsSpan = document.createElement("span");
          tsSpan.className = "event-timestamp";
          tsSpan.textContent = block.timestamp || "";
          left.appendChild(document.createTextNode(" "));
          left.appendChild(tsSpan);

          const hashSpan = document.createElement("span");
          hashSpan.className = "block-hash";
          const shortHash = (block.hash || "").slice(0, 12);
          hashSpan.textContent = shortHash ? "# " + shortHash + "â€¦" : "# genesis";

          header.appendChild(left);
          header.appendChild(hashSpan);
          blockNode.appendChild(header);

          const eventsContainer = document.createElement("div");
          eventsContainer.className = "event-list";

          const events = Array.isArray(block.data) ? block.data : [block.data];
          for (const ev of events) {
            if (!ev) continue;
            const item = document.createElement("div");
            item.className = "event-item";

            const typeSpan = document.createElement("span");
            typeSpan.className = "event-type info";
            const sev = (ev.severity || "info").toLowerCase();
            typeSpan.classList.add(sev);
            typeSpan.textContent = ev.type || "event";

            const srcSpan = document.createElement("span");
            srcSpan.className = "event-source";
            srcSpan.textContent = ev.source ? "@ " + ev.source : "";

            const tsEvSpan = document.createElement("span");
            tsEvSpan.className = "event-timestamp";
            tsEvSpan.textContent = ev.timestamp || "";

            item.appendChild(typeSpan);
            if (ev.message) {
              item.appendChild(document.createTextNode(" " + ev.message));
            }
            if (ev.source) {
              item.appendChild(document.createTextNode(" "));
              item.appendChild(srcSpan);
            }
            if (ev.timestamp) {
              item.appendChild(tsEvSpan);
            }

            eventsContainer.appendChild(item);
          }

          blockNode.appendChild(eventsContainer);
          container.appendChild(blockNode);
        }
      }

      function renderSummary(chainPayload) {
        const statBlocks = document.getElementById("stat-blocks");
        const statFileChanges = document.getElementById("stat-file-changes");
        const statNetChanges = document.getElementById("stat-net-changes");
        const statAccountChanges = document.getElementById("stat-account-changes");
        const statErrors = document.getElementById("stat-errors");
        const alertsList = document.getElementById("alerts-list");

        alertsList.innerHTML = "";

        if (!chainPayload || !Array.isArray(chainPayload.chain)) {
          statBlocks.textContent = "0";
          statFileChanges.textContent = "0";
          statNetChanges.textContent = "0";
          statAccountChanges.textContent = "0";
          statErrors.textContent = "0";
          alertsList.textContent = "No alerts yet.";
          return;
        }

        const blocks = chainPayload.chain;
        statBlocks.textContent = String(blocks.length);

        let fileChanges = 0;
        let netChanges = 0;
        let accountChanges = 0;
        let errors = 0;
        const alerts = [];

        for (let i = blocks.length - 1; i >= 0; i -= 1) {
          const block = blocks[i];
          const events = Array.isArray(block.data) ? block.data : [block.data];

          for (const ev of events) {
            if (!ev || !ev.type) continue;
            const t = ev.type;

            if (t === "file_integrity_change") fileChanges += 1;
            if (t === "network_port_change") netChanges += 1;
            if (t === "account_membership_change") accountChanges += 1;
            if (t.endsWith("_error")) errors += 1;

            const sev = (ev.severity || "info").toLowerCase();
            if (sev !== "info" || t.endsWith("_change") || t.endsWith("_error")) {
              alerts.push({
                blockIndex: block.index,
                type: t,
                severity: sev,
                message: ev.message || "",
                source: ev.source || "",
                timestamp: ev.timestamp || block.timestamp || "",
              });
            }
          }
        }

        statFileChanges.textContent = String(fileChanges);
        statNetChanges.textContent = String(netChanges);
        statAccountChanges.textContent = String(accountChanges);
        statErrors.textContent = String(errors);

        if (alerts.length === 0) {
          alertsList.textContent = "No alerts yet.";
          return;
        }

        alerts.slice(0, 10).forEach((a) => {
          const div = document.createElement("div");
          div.className = "alert-item";

          const typeSpan = document.createElement("span");
          typeSpan.className = "event-type " + (a.severity || "info");
          typeSpan.textContent = a.type;

          const tsSpan = document.createElement("span");
          tsSpan.className = "event-timestamp";
          tsSpan.textContent = a.timestamp;

          div.appendChild(typeSpan);
          if (a.message) {
            div.appendChild(document.createTextNode(" " + a.message));
          }
          if (a.source) {
            const src = document.createElement("span");
            src.className = "event-source";
            src.textContent = " @ " + a.source;
            div.appendChild(src);
          }
          div.appendChild(tsSpan);

          alertsList.appendChild(div);
        });
      }

      async function refreshStatus() {
        const healthEl = document.getElementById("health-text");
        const pendingCountEl = document.getElementById("pending-count");

        try {
          const [health, pending, chain, config] = await Promise.all([
            fetchJSON("/health"),
            fetchJSON("/pending"),
            fetchJSON("/chain"),
            fetchJSON("/config"),
          ]);

          if (health) {
            healthEl.textContent = health.valid ? "VALID" : "INVALID";
            healthEl.className = health.valid ? "status-ok" : "status-bad";
          }

          if (pending) {
            pendingCountEl.textContent = pending.count ?? 0;
          }

          if (chain) {
            renderChainTree(chain);
            renderSummary(chain);
          }

          renderConfig(config);
        } catch (err) {
          healthEl.textContent = "Error: " + err.message;
          healthEl.className = "status-bad";
        }
      }

      async function saveRoots() {
        const input = document.getElementById("cfg-roots-input");
        const status = document.getElementById("cfg-status");
        if (!input || !status) return;

        const lines = input.value.split(/\r?\n/).map((l) => l.trim()).filter((l) => l.length > 0);
        if (lines.length === 0) {
          status.textContent = "Please enter at least one folder.";
          return;
        }

        status.textContent = "Saving roots...";
        try {
          const updated = await fetchJSON("/config/roots", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ roots: lines }),
          });
          status.textContent = "Roots updated successfully.";
          renderConfig(updated);
        } catch (err) {
          status.textContent = "Error: " + (err && err.message ? err.message : "unable to save roots");
        }
      }

      async function validateChain() {
        const healthEl = document.getElementById("health-text");
        try {
          const result = await fetchJSON("/verify");
          if (result) {
            healthEl.textContent = result.valid ? "VALID" : "INVALID";
            healthEl.className = result.valid ? "status-ok" : "status-bad";
          }
        } catch (err) {
          healthEl.textContent = "Error: " + err.message;
          healthEl.className = "status-bad";
        }
      }

      async function minePending() {
        const pendingCountEl = document.getElementById("pending-count");
        try {
          await fetchJSON("/mine", { method: "POST" });
          await refreshStatus();
        } catch (err) {
          pendingCountEl.textContent = "Error";
        }
      }

      function toggleExcludesEditor() {
        const editor = document.getElementById("cfg-excludes-editor");
        if (!editor) return;
        editor.classList.toggle("hidden");
      }

      async function saveExcludes() {
        const input = document.getElementById("cfg-excludes-input");
        const status = document.getElementById("cfg-excludes-status");
        if (!input || !status) return;

        const lines = input.value.split(/\r?\n/).map((l) => l.trim()).filter((l) => l.length > 0);

        status.textContent = "Saving excluded dirs...";
        try {
          const updated = await fetchJSON("/config/excludes", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ excludeDirs: lines }),
          });
          status.textContent = "Excluded dirs updated.";
          renderConfig(updated);
        } catch (err) {
          status.textContent = "Error: " + (err && err.message ? err.message : "unable to save excludes");
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("refresh-btn").addEventListener("click", refreshStatus);
        document.getElementById("btn-verify").addEventListener("click", validateChain);
        document.getElementById("btn-mine").addEventListener("click", minePending);
        document.getElementById("btn-save-roots").addEventListener("click", saveRoots);
        document.getElementById("btn-toggle-excludes").addEventListener("click", toggleExcludesEditor);
        document.getElementById("btn-save-excludes").addEventListener("click", saveExcludes);
        refreshStatus();
      });
    </script>
  </body>
</html>
